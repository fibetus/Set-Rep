<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Set & Rep - Workout</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <style>
        .workout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .muscle-groups {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .muscle-group-btn {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: #f5f5f5;
        }

        .muscle-group-btn.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .exercise-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .exercise-card h3 {
            margin-top: 0;
            color: #333;
        }

        .exercise-card p {
            color: #666;
            margin: 5px 0;
        }

        .selected-exercises {
            margin-top: 30px;
        }

        .exercise-set {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .set-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .set-inputs input {
            width: 80px;
            padding: 5px;
        }

        .workout-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .workout-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .save-workout {
            background: #28a745;
            color: white;
        }

        .save-template {
            background: #17a2b8;
            color: white;
        }

        .cancel-workout {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="workout-container">
        <h1>Create Workout</h1>
        
        <!-- Muscle Group Filter -->
        <div class="muscle-groups" id="muscle-groups">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Exercise Selection -->
        <div class="exercises-grid" id="exercises-grid">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Selected Exercises -->
        <div class="selected-exercises" id="selected-exercises">
            <h2>Selected Exercises</h2>
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Workout Actions -->
        <div class="workout-actions">
            <button class="save-workout" onclick="saveWorkout()">Save Workout</button>
            <button class="save-template" onclick="saveAsTemplate()">Save as Template</button>
            <button class="cancel-workout" onclick="cancelWorkout()">Cancel</button>
        </div>
    </div>

    <script type="text/javascript" src="/static/js/api.js"></script>
    <script type="text/javascript">
        let selectedExercises = new Map();
        let currentMuscleGroup = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load muscle groups and exercises
        async function loadMuscleGroups() {
            if (!checkAuth()) return;

            try {
                const response = await fetch('/api/v1/muscle-groups/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const container = document.getElementById('muscle-groups');
                container.innerHTML = '';
                
                if (Array.isArray(data)) {
                    data.forEach(group => {
                        const button = document.createElement('button');
                        button.className = 'muscle-group-btn';
                        button.textContent = group.name;
                        button.onclick = () => filterExercises(group.id);
                        container.appendChild(button);
                    });
                } else {
                    console.error('Expected array of muscle groups, got:', data);
                }
            } catch (error) {
                console.error('Error loading muscle groups:', error);
            }
        }

        // Load exercises
        async function loadExercises(muscleGroupId = null) {
            if (!checkAuth()) return;

            try {
                const url = muscleGroupId 
                    ? `/api/v1/exercises/?muscle_group=${muscleGroupId}`
                    : '/api/v1/exercises/';
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const container = document.getElementById('exercises-grid');
                container.innerHTML = '';
                
                if (Array.isArray(data)) {
                    data.forEach(exercise => {
                        const card = createExerciseCard(exercise);
                        container.appendChild(card);
                    });
                } else {
                    console.error('Expected array of exercises, got:', data);
                }
            } catch (error) {
                console.error('Error loading exercises:', error);
            }
        }

        // Filter exercises by muscle group
        function filterExercises(muscleGroupId) {
            const buttons = document.querySelectorAll('.muscle-group-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentMuscleGroup = muscleGroupId;
            loadExercises(muscleGroupId);
        }

        // Create exercise card
        function createExerciseCard(exercise) {
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.innerHTML = `
                <h3>${exercise.name}</h3>
                <p>${exercise.description}</p>
                <p><strong>Equipment:</strong> ${exercise.equipment_needed}</p>
                <button onclick="addExercise(${JSON.stringify(exercise).replace(/"/g, '&quot;')})">
                    Add to Workout
                </button>
            `;
            return card;
        }

        // Add exercise to workout
        function addExercise(exercise) {
            if (!selectedExercises.has(exercise.id)) {
                selectedExercises.set(exercise.id, {
                    exercise: exercise,
                    sets: 3,
                    reps: 10,
                    weight: null
                });
                updateSelectedExercises();
            }
        }

        // Update selected exercises display
        function updateSelectedExercises() {
            const container = document.getElementById('selected-exercises');
            container.innerHTML = '<h2>Selected Exercises</h2>';
            
            selectedExercises.forEach((data, id) => {
                const exercise = data.exercise;
                const div = document.createElement('div');
                div.className = 'exercise-set';
                div.innerHTML = `
                    <h3>${exercise.name}</h3>
                    <div class="set-inputs">
                        <input type="number" min="1" value="${data.sets}" 
                               onchange="updateExercise(${id}, 'sets', this.value)" placeholder="Sets">
                        <input type="number" min="1" value="${data.reps}" 
                               onchange="updateExercise(${id}, 'reps', this.value)" placeholder="Reps">
                        <input type="number" min="0" step="0.5" value="${data.weight || ''}" 
                               onchange="updateExercise(${id}, 'weight', this.value)" placeholder="Weight (kg)">
                        <button onclick="removeExercise(${id})">Remove</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Update exercise details
        function updateExercise(id, field, value) {
            const data = selectedExercises.get(id);
            data[field] = value;
            selectedExercises.set(id, data);
        }

        // Remove exercise from workout
        function removeExercise(id) {
            selectedExercises.delete(id);
            updateSelectedExercises();
        }

        // Save workout
        async function saveWorkout() {
            try {
                const workoutData = {
                    exercises: Array.from(selectedExercises.entries()).map(([id, data]) => ({
                        exercise_id: id,
                        sets: data.sets,
                        reps: data.reps,
                        weight: data.weight
                    }))
                };

                const response = await fetch('/api/v1/workouts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(workoutData)
                });

                if (response.ok) {
                    window.location.href = 'index.html';
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to save workout');
                }
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Failed to save workout');
            }
        }

        // Save as template
        async function saveAsTemplate() {
            const name = prompt('Enter template name:');
            if (!name) return;

            try {
                const templateData = {
                    name: name,
                    exercises: Array.from(selectedExercises.entries()).map(([id, data]) => ({
                        exercise_id: id,
                        sets: data.sets,
                        reps: data.reps
                    }))
                };

                const response = await fetch('/api/v1/workout-templates/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    alert('Template saved successfully');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to save template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Failed to save template');
            }
        }

        // Cancel workout
        function cancelWorkout() {
            if (confirm('Are you sure you want to cancel this workout?')) {
                window.location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                loadMuscleGroups();
                loadExercises();
            }
        });
    </script>
</body>
</html> 